is_installed() {
    local brew_path="$1"
    local package="$2"
    local arch_cmd="$3"

    log "INFO" "Running is_installed with: brew_path=$brew_path, package=$package, arch_cmd=$arch_cmd"

    # Check if the exact package name is installed
    if $arch_cmd "$brew_path" list --formula | grep -qx "$package"; then
        log "INFO" "✅ Package '$package' found in '$brew_path'."
        return 0
    fi

    log "INFO" "⚠️ Package '$package' not found directly. Checking aliases..."

    # Extract aliases using awk
    local installed_names
    installed_names=$($arch_cmd "$brew_path" info --json=v2 --installed 2>/dev/null | awk -F'"' '
        /"name": *"/ { pkg_name=$4 }
        /"aliases": *\[/ { in_aliases=1; next }
        in_aliases && /\]/ { in_aliases=0; next }
        in_aliases { print $2, pkg_name }
    ' | grep -w "$package" | awk '{print $2}')

    log "INFO" "Extracted aliases for '$package': $installed_names"

    if [[ -n "$installed_names" ]]; then
        log "INFO" "✅ Package '$package' is installed as an alias for: $installed_names"
        return 0
    fi

    log "WARN" "❌ Package '$package' is NOT installed in '$brew_path'."
    return 1
}